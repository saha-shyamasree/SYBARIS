#!/usr/bin/python

from __future__ import division
import Bio
import os
import glob
import math

from Bio.Blast import NCBIXML

path = '/Volumes/ma-home/SYBARIS/WGS-AF293/Shyama/test/xml_output/'
#files = os.listdir(path)
E_VALUE_THRESHOLD = 0.04
print "file,query_def,match,e-value,p-value,start,end,identitie,align_length,coverage%,score,more"
for infile in glob.glob( os.path.join(path,'*.out')):
    file_handle = open(infile)
    blast_record_itr = Bio.Blast.NCBIXML.parse(file_handle)
    for blast_record in blast_record_itr:
        print os.path.basename(infile) + ",",
        print blast_record.query + ",",
        if(len(blast_record.alignments)>0):
            print "yes,",
            for alignment in blast_record.alignments:
                count=len(alignment.hsps)
                for hsp in alignment.hsps:
                    print hsp.expect,
                    print ",",
                    print (1-math.exp(-(hsp.expect))),
                    print ",",
                    print hsp.sbjct_start,
                    print ",",
                    print hsp.sbjct_end,
                    print ",",
                    print hsp.identities,
                    print ",",
                    print hsp.align_length,
                    print ",",
                    print round(hsp.identities/hsp.align_length,2),
                    print ",",
                    print hsp.score,
                    print ",",
                    if(count==1):    
                        print "1"
                    else:
                        print count
                        break
        else:
            print "no,,,,,,,,"

